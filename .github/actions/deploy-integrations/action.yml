name: Deploy Integrations
description: Deploy integrations to Botpress

inputs:
  environment:
    description: "Environment to deploy to production"
    required: true
  force:
    description: "Force re-deploying integrations"
    required: false
    default: "false"
  token_pat:
    description: "Botpress token for plus account"
    required: true
  plus_workspace_id:
    description: "Botpress workspace ID for plus"
    required: true

runs:
  using: "composite"
  steps:
    - name: Login to Botpress
      shell: bash
      run: |
        pnpm bp login -y --token ${{ inputs.token_pat }} --workspace-id ${{ inputs.plus_workspace_id }}

    - name: Deploy integrations
      shell: bash
      run: |
        # Make the integration-exists script executable
        chmod +x ./.github/scripts/integration-exists.sh

        # Get list of integration directories
        cd integrations
        for integration in */; do
          if [ -d "$integration" ]; then
            integration_name=${integration%/}
            # Go back to root directory to access the script
            cd ..
            exists=$(bash ./.github/scripts/integration-exists.sh $integration_name)
            echo "Integration $integration_name exists check result: $exists"
            cd integrations
            
            # Only deploy if integration doesn't exist or force is enabled
            echo "Force flag: ${{ inputs.force }}"
            if [ "$exists" = "0" ] || [ "${{ inputs.force }}" = "true" ]; then
              echo "Deploying integration: $integration_name (exists=$exists, force=${{ inputs.force }})"
              
              cd "$integration_name"
              
              # Deploy the integration (already built in setup step)
              echo "Deploying $integration_name..."
              if [ "${{ inputs.force }}" = "true" ]; then
                npx @botpress/cli deploy --force --public --confirm
              else
                npx @botpress/cli deploy --public --confirm
              fi
              
              cd ..
            else
              echo "Integration $integration_name already exists, skipping deployment (use force=true to override)"
            fi
          fi
        done

        echo "Deployment completed successfully"
