name: Deploy Interfaces
description: Deploy interfaces to Botpress

inputs:
  environment:
    description: "Environment to deploy to (staging/production)"
    required: true
  force:
    description: "Force re-deploying interfaces"
    required: false
    default: "false"
  token_cloud_ops_account:
    description: "Botpress token for cloud ops account"
    required: true
  cloud_ops_workspace_id:
    description: "Botpress workspace ID for cloud ops"
    required: true

runs:
  using: "composite"
  steps:
    - name: Login to Botpress
      shell: bash
      run: |
        pnpm bp login -y --token ${{ inputs.token_cloud_ops_account }} --workspace-id ${{ inputs.cloud_ops_workspace_id }}

    - name: Deploy interfaces
      shell: bash
      run: |
        echo "Deploying interfaces to ${{ inputs.environment }} environment"

        # Check if interfaces directory exists
        if [ -d "interfaces" ]; then
          cd interfaces
          for interface in */; do
            if [ -d "$interface" ]; then
              interface_name=${interface%/}
              echo "Deploying interface: $interface_name"
              
              cd "$interface_name"
              
              # Build the interface
              echo "Building $interface_name..."
              pnpm exec bp build
              
              # Deploy the interface
              echo "Deploying $interface_name..."
              if [ "${{ inputs.force }}" = "true" ]; then
                pnpm exec bp deploy --force
              else
                pnpm exec bp deploy
              fi
              
              cd ..
            fi
          done
        else
          echo "No interfaces directory found, skipping interface deployment"
        fi
